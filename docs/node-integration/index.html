<!doctype html><html lang=zh-CN><meta charset=utf-8><title>What to do if your CL broke the Node.js integration build · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog>博客</a><li class=active><a href=/docs>文档</a></ul></nav></header><main id=main><h1>What to do if your CL broke the Node.js integration build</h1><p><a href=https://github.com/nodejs/node>Node.js master</a> uses V8 stable or beta. For additional integration, the V8 team builds Node with <a href=https://chromium.googlesource.com/v8/v8.git>V8 master</a>, i.e., with a V8 version from today. We provide integration bots for <a href=https://build.chromium.org/p/client.v8.fyi/builders/V8%20Linux64%20-%20node.js%20integration>Linux</a>, <a href=https://build.chromium.org/p/client.v8.fyi/builders/V8%20Win64%20-%20node.js%20integration>Windows</a>, and <a href=https://build.chromium.org/p/client.v8.fyi/builders/V8%20Mac64%20-%20node.js%20integration>Mac</a>. For each successful build, the integration bot provides an <em>Archive link</em> from which you can download a Node executable (click on the <code>Build #</code> and search for <code>Archive</code>).<p>If the <a href=https://ci.chromium.org/p/v8/builders/luci.v8.try/v8_node_linux64_rel><code>v8_node_linux64_rel</code> bot</a> fails on the V8 Commit Queue, there is either a legitimate problem with your CL (fix it) or <a href=https://github.com/v8/node/ >Node</a> must be modified. If the Node tests failed, search for “Not OK” in the log files. <strong>This document describes how to reproduce the problem locally and how to make changes to <a href=https://github.com/v8/node/ >V8’s Node fork</a> if your V8 CL causes the build to fail.</strong><p><em>Note: Patches in V8’s fork are usually cherry-picked by the person who updates V8 in <a href=https://github.com/nodejs/node>Node</a> (usually several weeks or month later). If you merged a fix to V8’s Node fork, there’s nothing else you need to do.</em><h2 id=reproduce-locally>Reproduce locally <a href=#reproduce-locally aria-hidden=true class=bookmark>#</a></h2><p>Clone V8’s Node repository and check out the <abbr title="last known good revision">lkgr</abbr> branch.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">git</span> clone git@github.com:v8/node.git</span><br><span class=highlight-line><span class="token function">git</span> checkout -b vee-eight-lkgr origin/vee-eight-lkgr</span></code></pre><p>Or, if you already have a Node checkout, add <code>v8/node</code> as remote:<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">cd</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line><span class="token function">git</span> remote add v8-fork git@github.com:v8/node.git</span><br><span class=highlight-line><span class="token function">git</span> checkout -b vee-eight-lkgr v8-fork/vee-eight-lkgr</span></code></pre><p>Apply your patch, i.e., replace <code>node/deps/v8</code> with a copy of <code>v8</code> (lkgr branch) and build Node.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token variable">$V8</span>/tools/node/update_node.py <span class="token variable">$V8</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line><span class="token function">cd</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line>./configure --build-v8-with-gn <span class="token operator">&&</span> <span class="token function">make</span> -j48 <span class="token function">test</span></span></code></pre><p>You can run single tests.<pre class=language-bash><code class=language-bash><span class=highlight-line>./node test/parallel/test-that-you-want.js</span></code></pre><p>For debug builds, set <code>v8_optimized_debug</code> in <code>common.gypi</code> to <code>true</code> and run:<pre class=language-bash><code class=language-bash><span class=highlight-line>./configure --debug --build-v8-with-gn <span class="token operator">&&</span> <span class="token function">make</span> -j48 <span class="token function">test</span></span></code></pre><p>To run the debug binary, run <code>./node_g</code> rather than <code>./node</code>.<h2 id=make-changes-to-node.js>Make changes to Node.js <a href=#make-changes-to-node.js aria-hidden=true class=bookmark>#</a></h2><p>If you need to change something in <a href=https://github.com/v8/node/ >Node</a> so your CL doesn’t break the <a href=https://build.chromium.org/p/client.v8.fyi/builders/V8%20-%20node.js%20integration>build</a> anymore, do the following. <strong>You need a GitHub account for this</strong>.<h3 id=get-the-node-sources>Get the Node sources <a href=#get-the-node-sources aria-hidden=true class=bookmark>#</a></h3><p>Fork <a href=https://github.com/v8/node/ >V8’s Node repository on GitHub</a> (click the fork button). Clone your Node repository and check out the lkgr branch.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">git</span> clone git@github.com:your_user_name/node.git</span></code></pre><p>If you already have a checkout of your fork of Node, you do not fork the repo. Instead, add <code>v8/node</code> as remote:<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">cd</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line><span class="token function">git</span> remote add v8-fork git@github.com:v8/node.git</span><br><span class=highlight-line><span class="token function">git</span> checkout -b vee-eight-lkgr v8-fork/vee-eight-lkgr</span></code></pre><p>Make sure you have the correct branch and check that the current version builds and runs. Then create a new branch for your fix.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">git</span> checkout vee-eight-lkgr</span><br><span class=highlight-line>./configure --build-v8-with-gn <span class="token operator">&&</span> <span class="token function">make</span> -j48 <span class="token function">test</span></span><br><span class=highlight-line><span class="token function">git</span> checkout -b fix-something</span></code></pre><h3 id=apply-your-patch>Apply your patch <a href=#apply-your-patch aria-hidden=true class=bookmark>#</a></h3><p>Replace <code>node/deps/v8</code> with a copy of v8 (lkgr branch) and build Node.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token variable">$V8</span>/tools/node/update_node.py <span class="token variable">$V8</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line><span class="token function">cd</span> <span class="token variable">$NODE</span></span><br><span class=highlight-line>./configure --build-v8-with-gn <span class="token operator">&&</span> <span class="token function">make</span> -j48 <span class="token function">test</span></span></code></pre><p>The ninja build is quite a bit faster, but does not offer a <code>test</code> target.<pre class=language-bash><code class=language-bash><span class=highlight-line>./configure --build-v8-with-gn <span class="token operator">&&</span> autoninja -C out/Release</span><br><span class=highlight-line>tools/test.py</span></code></pre><h3 id=contribute-fixes-to-node>Contribute fixes to Node <a href=#contribute-fixes-to-node aria-hidden=true class=bookmark>#</a></h3><p>Make your changes to Node (not to <code>deps/v8</code>) and commit them.<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">git</span> commit -m <span class="token string">'subsystem: fix something'</span></span></code></pre><p><em>Note: if you make several commits, please squash them into one and format according to <a href=https://github.com/nodejs/node/blob/master/CONTRIBUTING.md#commit-guidelines>Node’s guidelines</a>. GitHub’s review works differently than V8 Chromium and your commit messages will end up in Node exactly how you wrote them locally. (It doesn’t matter what you type in the PR message.) It’s OK to force-push onto your <code>fix-something</code> branch.</em><p>Build and run the tests again. Double check that your formatting looks like the rest of the file.<pre class=language-bash><code class=language-bash><span class=highlight-line>./configure --build-v8-with-gn <span class="token operator">&&</span> <span class="token function">make</span> -j48 <span class="token function">test</span></span><br><span class=highlight-line><span class="token function">make</span> lint</span><br><span class=highlight-line><span class="token function">git</span> push origin fix-something</span></code></pre><p>Once you have pushed the fixes to your repository, open a Pull Request on GitHub. This sends an email to the <a href=https://github.com/orgs/v8/teams/node-js>V8 node-js team</a>. They will review and merge your PR. Once the PR is merged, you can run the CQ for your V8 commit again and land it. If you have specific questions, ping the <a href=https://github.com/orgs/v8/teams/node-js>V8 node-js team</a> maintainers.</main><footer id=footer><nav><a href=https://v8.dev/docs/node-integration>原文</a> · <a href=/logo>商标</a> · <a href=/terms>条款</a> · <a href=https://policies.google.com/privacy>隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.dev/tree/master/./src/docs/node-integration.md rel=nofollow>在 GitHub 编辑此页面</a></nav><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>