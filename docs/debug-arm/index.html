<!doctype html><html lang=zh-CN><meta charset=utf-8><title>ARM debugging with the simulator · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog>博客</a><li class=active><a href=/docs>文档</a></ul></nav></header><main id=main><h1>ARM debugging with the simulator</h1><p>The simulator and debugger can be very helpful when working with v8 code generation.<ul><li>It is convenient as it allows you to test code generation without access to actual hardware.<li>No cross or native compilation is needed.<li>The simulator fully supports the debugging of generated code.</ul><p>Please note that this simulator is designed for v8 purposes. Only the features used by v8 are implemented, and you might encounter unimplemented features or instructions. In this case, feel free to implement them and submit the code!<h2 id=details-on-the-arm-debugger>Details on the ARM debugger <a href=#details-on-the-arm-debugger aria-hidden=true class=bookmark>#</a></h2><p>Compile the ARM simulator shell with:<pre class=language-bash><code class=language-bash><span class=highlight-line><span class="token function">make</span> arm.debug</span></code></pre><p>…on an x86 host using your regular compiler.<h3 id=starting-the-debugger>Starting the debugger <a href=#starting-the-debugger aria-hidden=true class=bookmark>#</a></h3><p>There are different ways of starting the debugger:<pre class=language-bash><code class=language-bash><span class=highlight-line>out/arm.debug/d8 --stop_sim_at <span class="token operator">&lt;</span>n<span class="token operator">></span></span></code></pre><p>The simulator starts the debugger after executing <code>n</code> instructions.<pre class=language-bash><code class=language-bash><span class=highlight-line>out/arm.debug/d8 --stop_at <span class="token operator">&lt;</span>function name<span class="token operator">></span></span></code></pre><p>The simulator stops at the given JavaScript function.<p>Also you can directly generate 'stop' instructions in the ARM code. Stops are generated with<pre class=language-cpp><code class=language-cpp><span class=highlight-line>Assembler<span class="token operator">::</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> msg<span class="token punctuation">,</span> Condition cond<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> code<span class="token punctuation">)</span></span></code></pre><p>When the simulator hits a stop, it prints <code>msg</code> and starts the debugger.<h3 id=debugging-commands>Debugging commands <a href=#debugging-commands aria-hidden=true class=bookmark>#</a></h3><h4 id=usual-commands>Usual commands <a href=#usual-commands aria-hidden=true class=bookmark>#</a></h4><p>Enter <code>help</code> in the debugger prompt to get details on available commands. These include usual gdb-like commands, such as stepi, cont, disasm, etc. If the Simulator is run under gdb, the “gdb” debugger command will give control to gdb. You can then use cont from gdb to go back to the debugger.<h4 id=debugger-specific-commands>Debugger-specific commands <a href=#debugger-specific-commands aria-hidden=true class=bookmark>#</a></h4><p>Here's a list of the ARM debugger-specific commands, along with examples.<br>The JavaScript file <code>func.js</code> used below contains:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'In function test.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><ul><li><p><code>printobject $register</code> (alias <code>po</code>) describes an object held in a register:<pre class=language-bash><code class=language-bash><span class=highlight-line>$ out/arm.debug/d8 func.js --stop_at <span class="token function">test</span></span><br><br><span class=highlight-line>Simulator hit stop-at</span><br><span class=highlight-line>  0xb544d6a8  e92d4902       stmdb sp<span class="token operator">!</span>, <span class="token punctuation">{</span>r1, r8, fp, lr<span class="token punctuation">}</span></span><br><span class=highlight-line>sim<span class="token operator">></span> print r0</span><br><span class=highlight-line>r0: 0xb547ec15 -1253577707</span><br><span class=highlight-line>sim<span class="token operator">></span> printobject r0</span><br><span class=highlight-line>r0:</span><br><span class=highlight-line>0xb547ec15: <span class="token punctuation">[</span>Function<span class="token punctuation">]</span></span><br><span class=highlight-line>- map <span class="token operator">=</span> 0x0xb540ff01</span><br><span class=highlight-line>- initial_map <span class="token operator">=</span></span><br><span class=highlight-line>- shared_info <span class="token operator">=</span> 0xb547eb2d <span class="token operator">&lt;</span>SharedFunctionInfo<span class="token operator">></span></span><br><span class=highlight-line>  - name <span class="token operator">=</span> <span class="token comment">#test</span></span><br><span class=highlight-line>- context <span class="token operator">=</span> 0xb60083f1 <span class="token operator">&lt;</span>FixedArray<span class="token punctuation">[</span>52<span class="token punctuation">]</span><span class="token operator">></span></span><br><span class=highlight-line>- code <span class="token operator">=</span> 0xb544d681 <span class="token operator">&lt;</span>Code<span class="token operator">></span></span><br><span class=highlight-line>  <span class="token comment">#arguments: 0xb545a15d &lt;Proxy> (callback)</span></span><br><span class=highlight-line>  <span class="token comment">#length: 0xb545a14d &lt;Proxy> (callback)</span></span><br><span class=highlight-line>  <span class="token comment">#name: 0xb545a155 &lt;Proxy> (callback)</span></span><br><span class=highlight-line>  <span class="token comment">#prototype: 0xb545a145 &lt;Proxy> (callback)</span></span><br><span class=highlight-line>  <span class="token comment">#caller: 0xb545a165 &lt;Proxy> (callback)</span></span></code></pre><li><p><code>break</code> $address` inserts a breakpoint at the specified address.<li><p><code>del</code> deletes the current breakpoint.<p>You can have only one such breakpoint. This is useful if you want to insert a breakpoint at runtime.<pre class=language-bash><code class=language-bash><span class=highlight-line>$ out/arm.debug/d8 func.js --stop_at <span class="token function">test</span></span><br><br><span class=highlight-line>Simulator hit stop-at</span><br><span class=highlight-line>  0xb53a1ee8  e92d4902       stmdb sp<span class="token operator">!</span>, <span class="token punctuation">{</span>r1, r8, fp, lr<span class="token punctuation">}</span></span><br><span class=highlight-line>sim<span class="token operator">></span> disasm 5</span><br><span class=highlight-line>  0xb53a1ee8  e92d4902       stmdb sp<span class="token operator">!</span>, <span class="token punctuation">{</span>r1, r8, fp, lr<span class="token punctuation">}</span></span><br><span class=highlight-line>  0xb53a1eec  e28db008       add fp, sp, <span class="token comment">#8</span></span><br><span class=highlight-line>  0xb53a1ef0  e59a200c       ldr r2, <span class="token punctuation">[</span>r10, <span class="token comment">#+12]</span></span><br><span class=highlight-line>  0xb53a1ef4  e28fe004       add lr, pc, <span class="token comment">#4</span></span><br><span class=highlight-line>  0xb53a1ef8  e15d0002       <span class="token function">cmp</span> sp, r2</span><br><span class=highlight-line>sim<span class="token operator">></span> <span class="token keyword">break</span> 0xb53a1ef8</span><br><span class=highlight-line>sim<span class="token operator">></span> cont</span><br><span class=highlight-line>  0xb53a1ef8  e15d0002       <span class="token function">cmp</span> sp, r2</span><br><span class=highlight-line>sim<span class="token operator">></span> disasm 5</span><br><span class=highlight-line>  0xb53a1ef8  e15d0002       <span class="token function">cmp</span> sp, r2</span><br><span class=highlight-line>  0xb53a1efc  359ff034       ldrcc pc, <span class="token punctuation">[</span>pc, <span class="token comment">#+52]</span></span><br><span class=highlight-line>  0xb53a1f00  e5980017       ldr r0, <span class="token punctuation">[</span>r8, <span class="token comment">#+23]</span></span><br><span class=highlight-line>  0xb53a1f04  e59f1030       ldr r1, <span class="token punctuation">[</span>pc, <span class="token comment">#+48]</span></span><br><span class=highlight-line>  0xb53a1f08  e52d0004       str r0, <span class="token punctuation">[</span>sp, <span class="token comment">#-4]!</span></span><br><span class=highlight-line>sim<span class="token operator">></span> <span class="token keyword">break</span> 0xb53a1f08</span><br><span class=highlight-line>setting breakpoint failed</span><br><span class=highlight-line>sim<span class="token operator">></span> del</span><br><span class=highlight-line>sim<span class="token operator">></span> <span class="token keyword">break</span> 0xb53a1f08</span><br><span class=highlight-line>sim<span class="token operator">></span> cont</span><br><span class=highlight-line>  0xb53a1f08  e52d0004       str r0, <span class="token punctuation">[</span>sp, <span class="token comment">#-4]!</span></span><br><span class=highlight-line>sim<span class="token operator">></span> del</span><br><span class=highlight-line>sim<span class="token operator">></span> cont</span><br><span class=highlight-line>In <span class="token keyword">function</span> test.</span></code></pre><li><p>Generated <code>stop</code> instuctions work as breakpoints with a few additional features.</ul><p>The first argument is a help message, the second is the condition, and the third is the stop code. If a code is specified, and is less than 256, the stop is said to be “watched”, and can be disabled/enabled; a counter also keeps track of how many times the Simulator hits this code.<p>Imagine we are working on this V8 C++ code, which is reached when running our JavaScript file.<pre class=language-cpp><code class=language-cpp><span class=highlight-line>__ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"My stop."</span><span class="token punctuation">,</span> al<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"My second stop."</span><span class="token punctuation">,</span> al<span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>__ <span class="token function">mov</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r1<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Here's a sample debugging session:<p>We hit the first stop.<pre><code>Simulator hit My stop.
  0xb53559e8  e1a00000       mov r0, r0
</code></pre><p>We can see the following stop using disasm. The address of the message string is inlined in the code after the svc stop instruction.<pre><code>sim> disasm
  0xb53559e8  e1a00000       mov r0, r0
  0xb53559ec  e1a00000       mov r0, r0
  0xb53559f0  e1a00000       mov r0, r0
  0xb53559f4  e1a00000       mov r0, r0
  0xb53559f8  e1a00000       mov r0, r0
  0xb53559fc  ef800001       stop 1 - 0x1
  0xb5355a00  08338a97       stop message: My second stop
  0xb5355a04  e1a00000       mov r1, r1
  0xb5355a08  e1a00000       mov r1, r1
  0xb5355a0c  e1a00000       mov r1, r1
</code></pre><p>Information can be printed for all (watched) stops which were hit at least once.<pre><code>sim> stop info all
Stop information:
stop 123 - 0x7b:      Enabled,      counter = 1,      My stop.
sim> cont
Simulator hit My second stop
  0xb5355a04  e1a00000       mov r1, r1
sim> stop info all
Stop information:
stop 1 - 0x1:         Enabled,      counter = 1,      My second stop
stop 123 - 0x7b:      Enabled,      counter = 1,      My stop.
</code></pre><p>Stops can be disabled or enabled. (Only available for watched stops.)<pre><code>sim> stop disable 1
sim> cont
Simulator hit My stop.
  0xb5356808  e1a00000       mov r0, r0
sim> cont
Simulator hit My stop.
  0xb5356c28  e1a00000       mov r0, r0
sim> stop info all
Stop information:
stop 1 - 0x1:         Disabled,     counter = 2,      My second stop
stop 123 - 0x7b:      Enabled,      counter = 3,      My stop.
sim> stop enable 1
sim> cont
Simulator hit My second stop
  0xb5356c44  e1a00000       mov r1, r1
sim> stop disable all
sim> con
In function test.
</code></pre></main><footer id=footer><nav><a href=https://v8.dev/docs/debug-arm>原文</a> · <a href=/logo>商标</a> · <a href=/terms>条款</a> · <a href=https://policies.google.com/privacy>隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.dev/tree/master/./src/docs/debug-arm.md rel=nofollow>在 GitHub 编辑此页面</a></nav><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>