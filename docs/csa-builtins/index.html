<!doctype html><html lang=zh-CN><meta charset=utf-8><title>CodeStubAssembler builtins · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog>博客</a><li class=active><a href=/docs>文档</a></ul></nav></header><main id=main><h1>CodeStubAssembler builtins</h1><p>This document is intended as an introduction to writing CodeStubAssembler builtins, and is targeted towards V8 developers.<h2 id=builtins>Builtins <a href=#builtins aria-hidden=true class=bookmark>#</a></h2><p>In V8, builtins can be seen as chunks of code that are executable by the VM at runtime. A common use case is to implement the functions of builtin objects (such as RegExp or Promise), but builtins can also be used to provide other internal functionality (e.g. as part of the IC system).<p>V8’s builtins can be implemented using a number of different methods (each with different trade-offs):<ul><li><strong>Platform-dependent assembly language</strong>: can be highly efficient, but need manual ports to all platforms and are difficult to maintain.<li><strong>C++</strong>: very similar in style to runtime functions and have access to V8’s powerful runtime functionality, but usually not suited to performance-sensitive areas.<li><strong>JavaScript</strong>: concise and readable code, access to fast intrinsics, but frequent usage of slow runtime calls, subject to unpredictable performance through type pollution, and subtle issues around (complicated and non-obvious) JS semantics.<li><strong>CodeStubAssembler</strong>: provides efficient low-level functionality that is very close to assembly language while remaining platform-independent and preserving readability.</ul><p>The remaining document focuses on the latter and give a brief tutorial for developing a simple CodeStubAssembler (CSA) builtin exposed to JavaScript.<h2 id=codestubassembler>CodeStubAssembler <a href=#codestubassembler aria-hidden=true class=bookmark>#</a></h2><p>V8’s CodeStubAssembler is a custom, platform-agnostic assembler that provides low-level primitives as a thin abstraction over assembly, but also offers an extensive library of higher-level functionality.<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token comment">// Low-level:</span></span><br><span class=highlight-line><span class="token comment">// Loads the pointer-sized data at addr into value.</span></span><br><span class=highlight-line>Node<span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token comment">/* ... */</span><span class="token punctuation">;</span></span><br><span class=highlight-line>Node<span class="token operator">*</span> value <span class="token operator">=</span> <span class="token function">Load</span><span class="token punctuation">(</span>MachineType<span class="token operator">::</span><span class="token function">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line><span class="token comment">// And high-level:</span></span><br><span class=highlight-line><span class="token comment">// Performs the JS operation ToString(object).</span></span><br><span class=highlight-line><span class="token comment">// ToString semantics are specified at https://tc39.github.io/ecma262/#sec-tostring.</span></span><br><span class=highlight-line>Node<span class="token operator">*</span> object <span class="token operator">=</span> <span class="token comment">/* ... */</span><span class="token punctuation">;</span></span><br><span class=highlight-line>Node<span class="token operator">*</span> string <span class="token operator">=</span> <span class="token function">ToString</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>CSA builtins run through part of the TurboFan compilation pipeline (including block scheduling and register allocation, but notably not through optimization passes) which then emits the final executable code.<h2 id=writing-a-codestubassembler-builtin>Writing a CodeStubAssembler builtin <a href=#writing-a-codestubassembler-builtin aria-hidden=true class=bookmark>#</a></h2><p>In this section, we will write a simple CSA builtin that takes a single argument, and returns whether it represents the number <code>42</code>. The builtin is exposed to JS by installing it on the <code>Math</code> object (because we can).<p>This example demonstrates:<ul><li>Creating a CSA builtin with JavaScript linkage, which can be called like a JS function.<li>Using CSA to implement simple logic: Smi and heap-number handling, conditionals, and calls to TFS builtins.<li>Using CSA Variables.<li>Installation of the CSA builtin on the <code>Math</code> object.</ul><p>In case you’d like to follow along locally, the following code is based off revision <a href=https://chromium.googlesource.com/v8/v8/+/7a8d20a79f9d5ce6fe589477b09327f3e90bf0e0>7a8d20a7</a>.<h2 id=declaring-mathis42>Declaring <code>MathIs42</code> <a href=#declaring-mathis42 aria-hidden=true class=bookmark>#</a></h2><p>Builtins are declared in the <code>BUILTIN_LIST_BASE</code> macro in <a href="https://cs.chromium.org/chromium/src/v8/src/builtins/builtins-definitions.h?q=builtins-definitions.h+package:%5Echromium$&l=1"><code>src/builtins/builtins-definitions.h</code></a>. To create a new CSA builtin with JS linkage and one parameter named <code>X</code>:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token macro property">#<span class="token keyword directive">define</span> BUILTIN_LIST_BASE(CPP, API, TFJ, TFC, TFS, TFH, ASM, DBG)              \</span><br><span class=highlight-line>  </span><span class="token comment">// […snip…]</span></span><br><span class=highlight-line>  <span class="token function">TFJ</span><span class="token punctuation">(</span>MathIs42<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kX<span class="token punctuation">)</span>                                                         \</span><br><span class=highlight-line>  <span class="token comment">// […snip…]</span></span></code></pre><p>Note that <code>BUILTIN_LIST_BASE</code> takes several different macros that denote different builtin kinds (see inline documentation for more details). CSA builtins specifically are split into:<ul><li><strong>TFJ</strong>: JavaScript linkage.<li><strong>TFS</strong>: Stub linkage.<li><strong>TFC</strong>: Stub linkage builtin requiring a custom interface descriptor (e.g. if arguments are untagged or need to be passed in specific registers).<li><strong>TFH</strong>: Specialized stub linkage builtin used for IC handlers.</ul><h2 id=defining-mathis42>Defining <code>MathIs42</code> <a href=#defining-mathis42 aria-hidden=true class=bookmark>#</a></h2><p>Builtin definitions are located in <code>src/builtins/builtins-*-gen.cc</code> files, roughly organized by topic. Since we will be writing a <code>Math</code> builtin, we’ll put our definition into <a href="https://cs.chromium.org/chromium/src/v8/src/builtins/builtins-math-gen.cc?q=builtins-math-gen.cc+package:%5Echromium$&l=1"><code>src/builtins/builtins-math-gen.cc</code></a>.<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token comment">// TF_BUILTIN is a convenience macro that creates a new subclass of the given</span></span><br><span class=highlight-line><span class="token comment">// assembler behind the scenes.</span></span><br><span class=highlight-line><span class="token function">TF_BUILTIN</span><span class="token punctuation">(</span>MathIs42<span class="token punctuation">,</span> MathBuiltinsAssembler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token comment">// Load the current function context (an implicit argument for every stub)</span></span><br><span class=highlight-line>  <span class="token comment">// and the X argument. Note that we can refer to parameters by the names</span></span><br><span class=highlight-line>  <span class="token comment">// defined in the builtin declaration.</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">Parameter</span><span class="token punctuation">(</span>Descriptor<span class="token operator">::</span>kContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">Parameter</span><span class="token punctuation">(</span>Descriptor<span class="token operator">::</span>kX<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  <span class="token comment">// At this point, x can be basically anything - a Smi, a HeapNumber,</span></span><br><span class=highlight-line>  <span class="token comment">// undefined, or any other arbitrary JS object. Let’s call the ToNumber</span></span><br><span class=highlight-line>  <span class="token comment">// builtin to convert x to a number we can use.</span></span><br><span class=highlight-line>  <span class="token comment">// CallBuiltin can be used to conveniently call any CSA builtin.</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token function">CallBuiltin</span><span class="token punctuation">(</span>Builtins<span class="token operator">::</span>kToNumber<span class="token punctuation">,</span> context<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  <span class="token comment">// Create a CSA variable to store the resulting value. The type of the</span></span><br><span class=highlight-line>  <span class="token comment">// variable is kTagged since we will only be storing tagged pointers in it.</span></span><br><span class=highlight-line>  <span class="token function">VARIABLE</span><span class="token punctuation">(</span>var_result<span class="token punctuation">,</span> MachineRepresentation<span class="token operator">::</span>kTagged<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  <span class="token comment">// We need to define a couple of labels which will be used as jump targets.</span></span><br><span class=highlight-line>  Label <span class="token function">if_issmi</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">if_isheapnumber</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  <span class="token comment">// ToNumber always returns a number. We need to distinguish between Smis</span></span><br><span class=highlight-line>  <span class="token comment">// and heap numbers - here, we check whether number is a Smi and conditionally</span></span><br><span class=highlight-line>  <span class="token comment">// jump to the corresponding labels.</span></span><br><span class=highlight-line>  <span class="token function">Branch</span><span class="token punctuation">(</span><span class="token function">TaggedIsSmi</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&</span>if_issmi<span class="token punctuation">,</span> <span class="token operator">&</span>if_isheapnumber<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  <span class="token comment">// Binding a label begins generating code for it.</span></span><br><span class=highlight-line>  <span class="token function">BIND</span><span class="token punctuation">(</span><span class="token operator">&</span>if_issmi<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token comment">// SelectBooleanConstant returns the JS true/false values depending on</span></span><br><span class=highlight-line>    <span class="token comment">// whether the passed condition is true/false. The result is bound to our</span></span><br><span class=highlight-line>    <span class="token comment">// var_result variable, and we then unconditionally jump to the out label.</span></span><br><span class=highlight-line>    var_result<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token function">SelectBooleanConstant</span><span class="token punctuation">(</span><span class="token function">SmiEqual</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> <span class="token function">SmiConstant</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token function">Goto</span><span class="token punctuation">(</span><span class="token operator">&</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><br><span class=highlight-line>  <span class="token function">BIND</span><span class="token punctuation">(</span><span class="token operator">&</span>if_isheapnumber<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token comment">// ToNumber can only return either a Smi or a heap number. Just to make sure</span></span><br><span class=highlight-line>    <span class="token comment">// we add an assertion here that verifies number is actually a heap number.</span></span><br><span class=highlight-line>    <span class="token function">CSA_ASSERT</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">IsHeapNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token comment">// Heap numbers wrap a floating point value. We need to explicitly extract</span></span><br><span class=highlight-line>    <span class="token comment">// this value, perform a floating point comparison, and again bind</span></span><br><span class=highlight-line>    <span class="token comment">// var_result based on the outcome.</span></span><br><span class=highlight-line>    Node<span class="token operator">*</span> <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">LoadHeapNumberValue</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    Node<span class="token operator">*</span> <span class="token keyword">const</span> is_42 <span class="token operator">=</span> <span class="token function">Float64Equal</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">Float64Constant</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    var_result<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token function">SelectBooleanConstant</span><span class="token punctuation">(</span>is_42<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token function">Goto</span><span class="token punctuation">(</span><span class="token operator">&</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><br><span class=highlight-line>  <span class="token function">BIND</span><span class="token punctuation">(</span><span class="token operator">&</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">{</span></span><br><span class=highlight-line>    Node<span class="token operator">*</span> <span class="token keyword">const</span> result <span class="token operator">=</span> var_result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token function">CSA_ASSERT</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">IsBoolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token function">Return</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><h2 id=attaching-math.is42>Attaching <code>Math.Is42</code> <a href=#attaching-math.is42 aria-hidden=true class=bookmark>#</a></h2><p>Builtin objects such as <code>Math</code> are set up mostly in <a href="https://cs.chromium.org/chromium/src/v8/src/bootstrapper.cc?q=src/bootstrapper.cc+package:%5Echromium$&l=1"><code>src/bootstrapper.cc</code></a> (with some setup occurring in <code>.js</code> files). Attaching our new builtin is simple:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token comment">// Existing code to set up Math, included here for clarity.</span></span><br><span class=highlight-line>Handle<span class="token operator">&lt;</span>JSObject<span class="token operator">></span> math <span class="token operator">=</span> factory<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewJSObject</span><span class="token punctuation">(</span>cons<span class="token punctuation">,</span> TENURED<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>JSObject<span class="token operator">::</span><span class="token function">AddProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> name<span class="token punctuation">,</span> math<span class="token punctuation">,</span> DONT_ENUM<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// […snip…]</span></span><br><span class=highlight-line><span class="token function">SimpleInstallFunction</span><span class="token punctuation">(</span>math<span class="token punctuation">,</span> <span class="token string">"is42"</span><span class="token punctuation">,</span> Builtins<span class="token operator">::</span>kMathIs42<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Now that <code>Is42</code> is attached, it can be called from JS:<pre class=language-bash><code class=language-bash><span class=highlight-line>$ out/debug/d8</span><br><span class=highlight-line>d8<span class="token operator">></span> Math.is42<span class="token punctuation">(</span>42<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token boolean">true</span></span><br><span class=highlight-line>d8<span class="token operator">></span> Math.is42<span class="token punctuation">(</span><span class="token string">'42.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token boolean">true</span></span><br><span class=highlight-line>d8<span class="token operator">></span> Math.is42<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token boolean">false</span></span><br><span class=highlight-line>d8<span class="token operator">></span> Math.is42<span class="token punctuation">(</span><span class="token punctuation">{</span> valueOf: <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> 42 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token boolean">true</span></span></code></pre><h2 id=defining-and-calling-a-builtin-with-stub-linkage>Defining and calling a builtin with stub linkage <a href=#defining-and-calling-a-builtin-with-stub-linkage aria-hidden=true class=bookmark>#</a></h2><p>CSA builtins can also be created with stub linkage (instead of JS linkage as we used above in <code>MathIs42</code>). Such builtins can be useful to extract commonly-used code into a separate code object that can be used by multiple callers, while the code is only produced once. Let’s extract the code that handles heap numbers into a separate builtin called <code>MathIsHeapNumber42</code>, and call it from <code>MathIs42</code>.<p>Defining and using TFS stubs is easy; declaration are again placed in <a href="https://cs.chromium.org/chromium/src/v8/src/builtins/builtins-definitions.h?q=builtins-definitions.h+package:%5Echromium$&l=1"><code>src/builtins/builtins-definitions.h</code></a>:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token macro property">#<span class="token keyword directive">define</span> BUILTIN_LIST_BASE(CPP, API, TFJ, TFC, TFS, TFH, ASM, DBG)              \</span><br><span class=highlight-line>  </span><span class="token comment">// […snip…]</span></span><br><span class=highlight-line>  <span class="token function">TFS</span><span class="token punctuation">(</span>MathIsHeapNumber42<span class="token punctuation">,</span> kX<span class="token punctuation">)</span>                                                  \</span><br><span class=highlight-line>  <span class="token function">TFJ</span><span class="token punctuation">(</span>MathIs42<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kX<span class="token punctuation">)</span>                                                         \</span><br><span class=highlight-line>  <span class="token comment">// […snip…]</span></span></code></pre><p>Note that currently, order within <code>BUILTIN_LIST_BASE</code> does matter. Since <code>MathIs42</code> calls <code>MathIsHeapNumber42</code>, the former needs to be listed after the latter (this requirement should be lifted at some point).<p>The definition is also straightforward. In <a href="https://cs.chromium.org/chromium/src/v8/src/builtins/builtins-math-gen.cc?q=builtins-math-gen.cc+package:%5Echromium$&l=1"><code>src/builtins/builtins-math-gen.cc</code></a>:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token comment">// Defining a TFS builtin works exactly the same way as TFJ builtins.</span></span><br><span class=highlight-line><span class="token function">TF_BUILTIN</span><span class="token punctuation">(</span>MathIsHeapNumber42<span class="token punctuation">,</span> MathBuiltinsAssembler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">Parameter</span><span class="token punctuation">(</span>Descriptor<span class="token operator">::</span>kX<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token function">CSA_ASSERT</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">IsHeapNumber</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">LoadHeapNumberValue</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Node<span class="token operator">*</span> <span class="token keyword">const</span> is_42 <span class="token operator">=</span> <span class="token function">Float64Equal</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">Float64Constant</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token function">Return</span><span class="token punctuation">(</span><span class="token function">SelectBooleanConstant</span><span class="token punctuation">(</span>is_42<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>Finally, let’s call our new builtin from <code>MathIs42</code>:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token function">TF_BUILTIN</span><span class="token punctuation">(</span>MathIs42<span class="token punctuation">,</span> MathBuiltinsAssembler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token comment">// […snip…]</span></span><br><span class=highlight-line>  <span class="token function">BIND</span><span class="token punctuation">(</span><span class="token operator">&</span>if_isheapnumber<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token comment">// Instead of handling heap numbers inline, we now call into our new TFS stub.</span></span><br><span class=highlight-line>    var_result<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token function">CallBuiltin</span><span class="token punctuation">(</span>Builtins<span class="token operator">::</span>kMathIsHeapNumber42<span class="token punctuation">,</span> context<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token function">Goto</span><span class="token punctuation">(</span><span class="token operator">&</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line>  <span class="token comment">// […snip…]</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>Why should you care about TFS builtins at all? Why not leave the code inline (or extracted into a helper method for better readability)?<p>An important reason is code space: builtins are generated at compile-time and included in the V8 snapshot, thus unconditionally taking up (significant) space in every created isolate. Extracting large chunks of commonly used code to TFS builtins can quickly lead to space savings in the 10s to 100s of KBs.<h2 id=testing-stub-linkage-builtins>Testing stub-linkage builtins <a href=#testing-stub-linkage-builtins aria-hidden=true class=bookmark>#</a></h2><p>Even though our new builtin uses a non-standard (at least non-C++) calling convention, it’s possible to write test cases for it. The following code can be added to <a href="https://cs.chromium.org/chromium/src/v8/test/cctest/compiler/test-run-stubs.cc?l=1&rcl=4cab16db27808cf66ab883e7904f1891f9fd0717"><code>test/cctest/compiler/test-run-stubs.cc</code></a> to test the builtin on all platforms:<pre class=language-cpp><code class=language-cpp><span class=highlight-line><span class="token function">TEST</span><span class="token punctuation">(</span>MathIsHeapNumber42<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  HandleAndZoneScope scope<span class="token punctuation">;</span></span><br><span class=highlight-line>  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">main_isolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Heap<span class="token operator">*</span> heap <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Zone<span class="token operator">*</span> zone <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">main_zone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><br><span class=highlight-line>  StubTester <span class="token function">tester</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> zone<span class="token punctuation">,</span> Builtins<span class="token operator">::</span>kMathIs42<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  Handle<span class="token operator">&lt;</span>Object<span class="token operator">></span> result1 <span class="token operator">=</span> tester<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>Handle<span class="token operator">&lt;</span>Smi<span class="token operator">></span><span class="token punctuation">(</span>Smi<span class="token operator">::</span><span class="token function">FromInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token function">CHECK</span><span class="token punctuation">(</span>result1<span class="token operator">-</span><span class="token operator">></span><span class="token function">BooleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre></main><footer id=footer><nav><a href=https://v8.dev/docs/csa-builtins>原文</a> · <a href=/logo>商标</a> · <a href=/terms>条款</a> · <a href=https://policies.google.com/privacy>隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.dev/tree/master/./src/docs/csa-builtins.md rel=nofollow>在 GitHub 编辑此页面</a></nav><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>