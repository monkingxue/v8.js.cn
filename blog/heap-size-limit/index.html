<!doctype html><html lang=zh-CN><meta charset=utf-8><title>One small step for Chrome, one giant heap for V8 · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_css/main.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li class=active><a href=/blog>博客</a><li><a href=/docs>文档</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>One small step for Chrome, one giant heap for V8</h1><p class=meta>发布时间：<time datetime="2017-02-09 13:33:37" itemprop=datePublished title="2017-02-09 13:33:37">2017-02-09</time> · 标签： <a href=/blog/tags/memory class=tag>memory</a></header><div itemprop=articleBody><p>V8 has a hard limit on its heap size. This serves as a safeguard against applications with memory leaks. When an application reaches this hard limit, V8 does a series of last resort garbage collections. If the garbage collections do not help to free memory V8 stops execution and reports an out-of-memory failure. Without the hard limit a memory leaking application could use up all system memory hurting the performance of other applications.<p>Ironically, this safeguard mechanism makes investigation of memory leaks harder for JavaScript developers. The application can run out of memory before the developer manages to inspect the heap in DevTools. Moreover the DevTools process itself can run out memory because it uses an ordinary V8 instance. For example, taking a heap snapshot of <a href=https://ulan.github.io/misc/heap-snapshot-demo.html>this demo</a> will abort execution due to out-of-memory on the current stable Chrome.<p>Historically the V8 heap limit was conveniently set to fit the signed 32-bit integer range with some margin. Over time this convenience lead to sloppy code in V8 that mixed types of different bit widths, effectively breaking the ability to increase the limit. Recently we cleaned up the garbage collector code, enabling the use of larger heap sizes. DevTools already makes use of this feature and taking a heap snapshot in the previously mentioned demo works as expected in the latest Chrome Canary.<p>We also added a feature in DevTools to pause the application when it is close to running out of memory. This feature is useful to investigate bugs that cause the application to allocate a lot of memory in a short period of time. When running <a href=https://ulan.github.io/misc/oom.html>this demo</a> with the latest Chrome Canary, DevTools pauses the application before the out-of-memory failure and increases the heap limit, giving the user a chance to inspect the heap, evaluate expressions on the console to free memory and then resume execution for further debugging.<figure><img alt="" src=/_img/heap-size-limit/debugger.png></figure><p>V8 embedders can increase the heap limit using the <a href="https://codesearch.chromium.org/chromium/src/v8/include/v8.h?q=set_max_old_space_size"><code>set_max_old_space_size</code></a> function of the <code>ResourceConstraints</code> API. But watch out, some phases in the garbage collector have a linear dependency on the heap size. Garbage collection pauses may increase with larger heaps.</div><footer><div><img alt="" src=/_img/avatars/ulan-degenbaev.jpg height=96 lazyload=on srcset="/_img/avatars/ulan-degenbaev@2x.jpg 2x" width=96> <img alt="" src=/_img/avatars/michael-lippautz.jpg height=96 lazyload=on srcset="/_img/avatars/michael-lippautz@2x.jpg 2x" width=96> <img alt="" src=/_img/avatars/hannes-payer.jpg height=96 lazyload=on srcset="/_img/avatars/hannes-payer@2x.jpg 2x" width=96><p>作者：guardians of the heap Ulan Degenbaev, Hannes Payer, Michael Lippautz, and DevTools master Alexey Kozyatinskiy.</div></footer></article></main><footer id=footer><nav><a href=https://v8.dev/blog/heap-size-limit>原文</a> · <a href=/logo>商标</a> · <a href=/terms>条款</a> · <a href=https://policies.google.com/privacy>隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.dev/tree/master/./src/blog/heap-size-limit.md rel=nofollow>在 GitHub 编辑此页面</a></nav><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>